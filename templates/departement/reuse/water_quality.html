{% extends "departement/reuse/base_reuse.html" %}

{% block reuse_content %}
<!-- SVG Logo Styles -->
<style>
.svg-logo-container {
    position: absolute;
    top: 20px;
    right: 40px;
    z-index: 10;
    opacity: 0.15;
    width: 120px;
    height: 120px;
    pointer-events: none;
}

.subtle-logo {
    width: 100%;
    height: 100%;
    transition: opacity 0.3s ease;
}

.subtle-logo:hover {
    opacity: 0.3;
}
</style>

<div class="container-fluid pt-4 position-relative">
    <!-- SVG Logo -->
    <div class="svg-logo-container">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 200 200" class="dshapes abstract-226 subtle-logo">
            <g clip-path="url(#cs_clip_1_abstract-226)">
                <mask id="cs_mask_1_abstract-226" style="mask-type:alpha" width="200" height="200" x="0" y="0" maskUnits="userSpaceOnUse">
                    <polygon fill="#fff" fill-rule="evenodd" clip-rule="evenodd" points="117.09 101.62 113.57 73.57 110.05 101.62 82.01 105.14 110.05 108.65 113.57 136.7 117.09 108.65 145.14 105.14 117.09 101.62"></polygon>
                    <polygon fill="#fff" fill-rule="evenodd" clip-rule="evenodd" points="148.05 94.98 150.44 75.96 169.45 73.57 150.44 71.19 148.05 52.17 145.66 71.19 126.65 73.57 145.66 75.96 148.05 94.98"></polygon>
                    <polygon fill="#fff" fill-rule="evenodd" clip-rule="evenodd" points="151.13 110.08 149.08 126.42 132.74 128.47 149.08 130.52 151.13 146.86 153.18 130.52 169.52 128.47 153.18 126.42 151.13 110.08"></polygon>
                    <path fill="#fff" fill-rule="evenodd" clip-rule="evenodd" d="M132.37,35.26c-11.79,0-22.84,3.16-32.37,8.66-9.52-5.5-20.58-8.66-32.37-8.66C31.88,35.26,2.9,64.25,2.9,100s28.98,64.73,64.73,64.73c11.79,0,22.85-3.15,32.37-8.66,9.52,5.51,20.58,8.66,32.37,8.66,35.75,0,64.73-28.98,64.73-64.73s-28.98-64.74-64.73-64.74ZM132.37,159.96c-10.02,0-19.47-2.46-27.77-6.81-19.14-10.02-32.19-30.06-32.19-53.15s13.05-43.14,32.19-53.15c8.3-4.35,17.75-6.81,27.77-6.81,33.11,0,59.96,26.85,59.96,59.96s-26.85,59.96-59.96,59.96Z"></path>
                </mask>
                <g mask="url(#cs_mask_1_abstract-226)">
                    <path fill="#fff" d="M200 0H0v200h200V0z"></path>
                    <path fill="url(#paint0_linear_748_4808)" d="M200 0H0v200h200V0z"></path>
                    <g filter="url(#filter0_f_748_4808)">
                        <path fill="#FF58E4" d="M130 0H69v226h61V0z"></path>
                        <path fill="#0CE548" fill-opacity="0.35" d="M196 91H82v102h114V91z"></path>
                        <path fill="#FFE500" fill-opacity="0.74" d="M226 80H28v120h85V80z"></path>
                    </g>
                </g>
            </g>
            <defs>
                <filter id="filter0_f_748_4808" width="278" height="310" x="-27" y="-55" color-interpolation-filters="sRGB" filterUnits="userSpaceOnUse">
                    <feFlood flood-opacity="0" result="BackgroundImageFix"></feFlood>
                    <feBlend in="SourceGraphic" in2="BackgroundImageFix" result="shape"></feBlend>
                    <feGaussianBlur result="effect1_foregroundBlur_748_4808" stdDeviation="27.5"></feGaussianBlur>
                </filter>
                <linearGradient id="paint0_linear_748_4808" x1="186.5" x2="37" y1="37" y2="186.5" gradientUnits="userSpaceOnUse">
                    <stop stop-color="#0E6FFF" stop-opacity="0.51"></stop>
                    <stop offset="1" stop-color="#00F0FF" stop-opacity="0.59"></stop>
                </linearGradient>
                <clipPath id="cs_clip_1_abstract-226">
                    <path fill="#fff" d="M0 0H200V200H0z"></path>
                </clipPath>
            </defs>
            <g style="mix-blend-mode:overlay" mask="url(#cs_mask_1_abstract-226)">
                <path fill="gray" stroke="transparent" d="M200 0H0v200h200V0z" filter="url(#cs_noise_1_abstract-226)"></path>
            </g>
            <defs>
                <filter id="cs_noise_1_abstract-226" width="100%" height="100%" x="0%" y="0%" filterUnits="objectBoundingBox">
                    <feTurbulence baseFrequency="0.7" numOctaves="5" result="out1" seed="4"></feTurbulence>
                    <feComposite in="out1" in2="SourceGraphic" operator="in" result="out2"></feComposite>
                    <feBlend in="SourceGraphic" in2="out2" mode="overlay" result="out3"></feBlend>
                </filter>
            </defs>
        </svg>
    </div>

    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-info bg-opacity-25 text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-tint me-2"></i>
                        Évaluation de la Qualité de l'Eau
                    </h5>
                </div>
                <div class="card-body">
                    <form id="waterQualityForm" method="POST" action="{{ url_for('water_quality.water_quality_evaluation_route') }}">
                        {% for param_type, metadata in parameter_metadata.items() %}
                        <!-- {{ metadata.title }} -->
                        <div class="card mb-4">
                            <div class="card-header bg-{{ metadata.color }} bg-opacity-25 text-dark">
                                <h6 class="mb-0"><i class="fas fa-{{ metadata.icon }} me-2"></i>{{ metadata.title }}</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% for param_id, param in metadata.parameters.items() %}
                                    <div class="col-md-{{ 12 // metadata.parameters|length }} mb-3">
                                        <label for="{{ param_id }}" class="form-label">{{ param.name }}{% if param.unit %} ({{ param.unit }}){% endif %}</label>
                                        <input type="number" 
                                               class="form-control" 
                                               id="{{ param_id }}" 
                                               name="{{ param_id }}"
                                               step="{{ param.step }}"
                                               min="{{ param.min }}"
                                               required>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                        <button type="submit" class="btn btn-info bg-opacity-75 text-dark">
                            <i class="fas fa-check-circle me-2"></i>Évaluer la Qualité
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include the evaluation modal -->
{% include 'departement/reuse/components/evaluation_modal.html' %}

<!-- Custom JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('waterQualityForm');
    let evaluationModal;
    let progressBar;

    // Initialize modal
    const modalElement = document.getElementById('evaluationModal');
    if (modalElement) {
        evaluationModal = new bootstrap.Modal(modalElement, {
            backdrop: 'static',
            keyboard: false
        });
        progressBar = modalElement.querySelector('.progress-bar');
    }

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Show the evaluation modal
        if (evaluationModal) {
            evaluationModal.show();
        }

        // Reset progress bar
        if (progressBar) {
            progressBar.style.width = '0%';
        }

        try {
            // Create FormData from form
            const formData = new FormData(this);
            
            // Convert FormData to URLSearchParams for proper submission
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    params.append(key, numValue);
                }
            }

            // Simulate progress over exactly 5 seconds
            const updateProgress = (progress) => {
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
            };

            // Calculate progress increments
            const totalDuration = 5000; // 5 seconds
            const updateInterval = 50; // update every 50ms
            const totalSteps = totalDuration / updateInterval;
            let currentStep = 0;

            const progressInterval = setInterval(() => {
                currentStep++;
                const progress = (currentStep / totalSteps) * 100;
                
                if (currentStep <= totalSteps) {
                    updateProgress(progress);
                } else {
                    clearInterval(progressInterval);
                }
            }, updateInterval);

            // Make the request
            const response = await fetch("{{ url_for('water_quality.water_quality_evaluation_route') }}", {
                method: 'POST',
                body: params,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            
            // Create URL with parameters
            const url = new URL("{{ url_for('water_quality.water_quality_results', _external=True) }}");
            for (const [key, value] of params.entries()) {
                url.searchParams.append(key, value);
            }
            
            // Wait for animation to complete (5 seconds)
            setTimeout(() => {
                window.location.href = url.toString();
            }, 5000);

        } catch (error) {
            console.error('Error:', error);
            if (evaluationModal) {
                evaluationModal.hide();
            }
            // Show error alert
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>Une erreur est survenue lors de l'évaluation. Veuillez réessayer.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            form.insertAdjacentHTML('beforebegin', alertHtml);
        }
    });
});
</script>

<!-- Modal styles -->
<style>
@import url("{{ url_for('static', filename='css/logo_animation.css') }}");

/* Modal customization */
#evaluationModal .modal-content {
    background: linear-gradient(145deg, #2c3e50, #34495e);
    border-radius: 20px;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
    overflow: hidden;
    border: none;
}

#evaluationModal .modal-dialog {
    max-width: 500px;
}

#evaluationModal .logo-container {
    margin: 2rem auto;
}

#evaluationModal .text-center {
    color: #fff;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

#evaluationModal .progress-bar {
    transition: width 0.05s linear;
}
</style>
{% endblock %}
