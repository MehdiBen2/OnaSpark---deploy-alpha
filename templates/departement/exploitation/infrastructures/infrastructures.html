{% extends "departement/exploitation.html" %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Infrastructures</h3>
            <div class="d-flex justify-content-between align-items-center">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#infrastructureModal">
                    Ajouter Infrastructure
                </button>
                <button type="button" id="debugJsButton" class="btn btn-warning">
                    üêû Test JavaScript
                </button>
            </div>
        </div>
        <div class="card-body">
            <table id="infrastructuresTable" class="table table-striped">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Type</th>
                        <th>Localisation</th>
                        <th>Capacit√©</th>
                        <th>√âtat</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for infrastructure in infrastructures %}
                    <tr>
                        <td>{{ infrastructure.nom }}</td>
                        <td>{{ infrastructure.type }}</td>
                        <td>{{ infrastructure.localisation }}</td>
                        <td>{{ infrastructure.capacite }}</td>
                        <td>{{ infrastructure.etat }}</td>
                        <td>
                            <button class="btn btn-sm btn-info">√âditer</button>
                            <button class="btn btn-sm btn-danger">Supprimer</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Infrastructure Modal -->
<div class="modal fade" id="infrastructureModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter une Infrastructure</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="infrastructureForm">
                    <div class="mb-3">
                        <label for="nom" class="form-label">Nom</label>
                        <input type="text" class="form-control" id="nom" required>
                    </div>
                    <div class="mb-3">
                        <label for="type" class="form-label">Type</label>
                        <select class="form-select" id="type" required>
                            <option value="">S√©lectionner un type</option>
                            <option value="STEP">Station d'√©puration</option>
                            <option value="SP">Station de pompage</option>
                            <option value="AUTRE">Autre</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="localisation" class="form-label">Localisation</label>
                        <input type="text" class="form-control" id="localisation" required>
                    </div>
                    <div class="mb-3">
                        <label for="capacite" class="form-label">Capacit√©</label>
                        <input type="number" class="form-control" id="capacite" required>
                    </div>
                    <div class="mb-3">
                        <label for="etat" class="form-label">√âtat</label>
                        <select class="form-select" id="etat" required>
                            <option value="">S√©lectionner un √©tat</option>
                            <option value="OPERATIONNEL">Op√©rationnel</option>
                            <option value="MAINTENANCE">En maintenance</option>
                            <option value="PANNE">En panne</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="saveInfrastructureBtn">Enregistrer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
    console.log('Infrastructure page scripts starting...');
    
    // Debug logging function
    function debugLog(message, data = null, type = 'log') {
        const timestamp = new Date().toISOString();
        const logMessage = `[${timestamp}] [Infrastructure Debug] ${message}`;
        console[type](logMessage, data || '');
    }

    // Check script dependencies
    function checkScriptDependencies() {
        const dependencies = {
            jQuery: {
                loaded: typeof jQuery !== 'undefined',
                version: jQuery ? jQuery.fn.jquery : 'Not loaded'
            },
            Bootstrap: {
                loaded: typeof bootstrap !== 'undefined',
                version: bootstrap ? bootstrap.version : 'Not loaded'
            },
            DataTables: {
                loaded: typeof $.fn.DataTable !== 'undefined',
                version: $.fn.DataTable.version || 'Unknown'
            }
        };

        debugLog('Script Dependencies:', dependencies);
        return dependencies;
    }

    // Initialize page functionality
    function initializePage() {
        debugLog('Initializing page...');
        
        // Initialize DataTable
        if (document.getElementById('infrastructuresTable')) {
            try {
                const table = $('#infrastructuresTable').DataTable({
                    responsive: true,
                    language: {
                        url: '/static/vendor/dataTables/fr_FR.json'
                    }
                });
                debugLog('DataTable initialized successfully');
            } catch (error) {
                console.error('DataTable initialization error:', error);
            }
        }

        // Initialize save button handler
        const saveButton = document.querySelector('#saveInfrastructureBtn');
        if (saveButton) {
            saveButton.addEventListener('click', handleSaveInfrastructure);
            debugLog('Save button handler initialized');
        }

        // Initialize debug button
        const debugButton = document.getElementById('debugJsButton');
        if (debugButton) {
            debugButton.addEventListener('click', function() {
                const diagnosticInfo = {
                    dependencies: checkScriptDependencies(),
                    browser: {
                        userAgent: navigator.userAgent,
                        language: navigator.language,
                        cookiesEnabled: navigator.cookieEnabled,
                        screen: {
                            width: window.screen.width,
                            height: window.screen.height
                        }
                    }
                };

                debugLog('Diagnostic Information:', diagnosticInfo, 'warn');
                alert('üêû JavaScript Debug Test Complete! Check Console for Details.');
            });
            debugLog('Debug button handler initialized');
        }
    }

    // Handle infrastructure save
    function handleSaveInfrastructure(event) {
        event.preventDefault();
        debugLog('Handling infrastructure save...');

        const formData = {
            nom: document.getElementById('nom').value,
            type: document.getElementById('type').value,
            localisation: document.getElementById('localisation').value,
            capacite: document.getElementById('capacite').value,
            etat: document.getElementById('etat').value
        };

        // Validate form data
        const missingFields = Object.entries(formData)
            .filter(([_, value]) => !value)
            .map(([key]) => key);

        if (missingFields.length > 0) {
            alert('Veuillez remplir tous les champs: ' + missingFields.join(', '));
            return;
        }

        debugLog('Sending form data:', formData);

        // Send request
        fetch('{{ url_for("infrastructures.create_infrastructure") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            debugLog('Server response:', data);
            if (data.message) {
                alert(data.message);
                const modal = bootstrap.Modal.getInstance(document.getElementById('infrastructureModal'));
                if (modal) {
                    modal.hide();
                }
                location.reload();
            }
        })
        .catch(error => {
            debugLog('Error occurred:', error, 'error');
            alert('Erreur lors de l\'enregistrement: ' + error.message);
        });
    }

    // Initialize everything when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        debugLog('DOM loaded, checking dependencies...');
        const deps = checkScriptDependencies();
        
        if (deps.jQuery.loaded && deps.Bootstrap.loaded && deps.DataTables.loaded) {
            initializePage();
        } else {
            console.error('Required dependencies not loaded:', deps);
        }
    });
</script>
{% endblock %}
