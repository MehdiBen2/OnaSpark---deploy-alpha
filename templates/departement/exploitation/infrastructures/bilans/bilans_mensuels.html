{% extends "base/base.html" %}

{% block title %}Bilans Mensuels{% endblock %}

{% block extra_css %}
<style>
    .editor-container {
        max-width: 1600px;
        margin: 20px auto;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    #editor-actions {
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #save-status {
        margin-left: 15px;
        font-size: 0.9em;
    }
    #document-editor {
        min-height: 800px;
        border: 1px solid #ddd;
    }
    /* Office-like Ribbon Styling */
    .office-ribbon {
        background: linear-gradient(to bottom, #f0f2f5, #e6e9ef);
        border-bottom: 1px solid #d1d8e0;
        padding: 5px 10px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
    }
    .office-ribbon-tab {
        display: flex;
        align-items: center;
        margin-right: 15px;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 4px;
        transition: background-color 0.3s;
    }
    .office-ribbon-tab:hover {
        background-color: rgba(0,0,0,0.1);
    }
    .office-ribbon-tab.active {
        background-color: rgba(0,0,0,0.15);
    }
    .office-ribbon-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0 5px;
    }
    .office-ribbon-group-title {
        font-size: 0.7em;
        color: #666;
        margin-top: 3px;
    }
    .office-ribbon-dropdown {
        position: relative;
        display: inline-block;
    }
    .office-ribbon-dropdown-content {
        display: none;
        position: absolute;
        background-color: #f9f9f9;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1;
    }
    .office-ribbon-dropdown:hover .office-ribbon-dropdown-content {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="editor-container">
        <div id="editor-actions">
            <h2>Bilans Mensuels - Éditeur de Document</h2>
            <div>
                <button id="save-document" class="btn btn-primary">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
                <button id="export-pdf" class="btn btn-secondary">
                    <i class="fas fa-file-pdf"></i> Exporter PDF
                </button>
                <span id="save-status"></span>
            </div>
        </div>
        
        <div id="office-ribbon" class="office-ribbon">
            <!-- File Tab -->
            <div class="office-ribbon-tab" data-tab="file">
                <i class="fas fa-file"></i> Fichier
                <div class="office-ribbon-dropdown-content">
                    <button class="dropdown-item" id="btn-new">
                        <i class="fas fa-plus"></i> Nouveau
                    </button>
                    <button class="dropdown-item" id="btn-open">
                        <i class="fas fa-folder-open"></i> Ouvrir
                    </button>
                    <button class="dropdown-item" id="btn-save">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                    <button class="dropdown-item" id="btn-export-pdf">
                        <i class="fas fa-file-pdf"></i> Exporter PDF
                    </button>
                </div>
            </div>

            <!-- Home Tab -->
            <div class="office-ribbon-tab active" data-tab="home">
                <i class="fas fa-home"></i> Accueil
                <div class="office-ribbon-group">
                    <div class="office-ribbon-dropdown">
                        <button class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-font"></i>
                            <div class="office-ribbon-group-title">Police</div>
                        </button>
                        <div class="office-ribbon-dropdown-content">
                            <button class="dropdown-item">Taille</button>
                            <button class="dropdown-item">Couleur</button>
                            <button class="dropdown-item">Style</button>
                        </div>
                    </div>
                </div>
                <div class="office-ribbon-group">
                    <button class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-bold"></i>
                        <div class="office-ribbon-group-title">Gras</div>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-italic"></i>
                        <div class="office-ribbon-group-title">Italique</div>
                    </button>
                </div>
                <div class="office-ribbon-group">
                    <button class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-align-left"></i>
                        <div class="office-ribbon-group-title">Alignement</div>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-list-ul"></i>
                        <div class="office-ribbon-group-title">Liste</div>
                    </button>
                </div>
            </div>

            <!-- Insert Tab -->
            <div class="office-ribbon-tab" data-tab="insert">
                <i class="fas fa-plus-circle"></i> Insertion
                <div class="office-ribbon-group">
                    <button class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-table"></i>
                        <div class="office-ribbon-group-title">Tableau</div>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-image"></i>
                        <div class="office-ribbon-group-title">Image</div>
                    </button>
                </div>
            </div>

            <!-- Review Tab -->
            <div class="office-ribbon-tab" data-tab="review">
                <i class="fas fa-spell-check"></i> Révision
                <div class="office-ribbon-group">
                    <button class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-search"></i>
                        <div class="office-ribbon-group-title">Rechercher</div>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-spell-check"></i>
                        <div class="office-ribbon-group-title">Orthographe</div>
                    </button>
                </div>
            </div>
        </div>

        <div id="document-editor"></div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/classic/ckeditor.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Ribbon Tab Switching
        const ribbonTabs = document.querySelectorAll('.office-ribbon-tab');
        ribbonTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                ribbonTabs.forEach(t => t.classList.remove('active'));
                // Add active class to clicked tab
                this.classList.add('active');
            });
        });

        ClassicEditor
            .create(document.querySelector('#document-editor'), {
                toolbar: {
                    items: [
                        // Comprehensive Toolbar
                        'undo', 'redo', '|',
                        'cut', 'copy', 'paste', '|',
                        
                        // Formatting
                        'heading', '|',
                        'bold', 'italic', 'underline', 'strikethrough', 'subscript', 'superscript', '|',
                        'fontFamily', 'fontSize', 'fontColor', 'fontBackgroundColor', '|',
                        
                        // Paragraph and Alignment
                        'alignment', '|',
                        'bulletedList', 'numberedList', 'indent', 'outdent', '|',
                        
                        // Insertion
                        'insertTable', 'link', 'imageUpload', 'horizontalLine', 'pageBreak', '|',
                        
                        // Advanced
                        'findAndReplace', 'selectAll', 'showBlocks'
                    ],
                    shouldNotGroupWhenFull: true
                },
                language: 'fr',
                
                // Advanced Typing Configurations
                typing: {
                    transformations: {
                        remove: [
                            'quotes',
                            'typography'
                        ],
                        extra: [
                            { from: '(c)', to: '©' },
                            { from: '--', to: '—' },
                            { from: '(tm)', to: '™' },
                            { from: '(r)', to: '®' }
                        ]
                    }
                },
                
                image: {
                    toolbar: [
                        'imageTextAlternative',
                        'toggleImageCaption',
                        'imageStyle:inline',
                        'imageStyle:block',
                        'imageStyle:side'
                    ]
                },
                
                table: {
                    contentToolbar: [
                        'tableColumn',
                        'tableRow',
                        'mergeTableCells',
                        'tableCellProperties',
                        'tableProperties'
                    ]
                }
            })
            .then(editor => {
                window.editor = editor;  // Make editor globally accessible
                
                // Ribbon Button Interactions
                document.getElementById('btn-new').addEventListener('click', () => {
                    if(confirm('Voulez-vous créer un nouveau document ?')) {
                        editor.setData('');
                    }
                });

                document.getElementById('btn-open').addEventListener('click', () => {
                    alert('Fonctionnalité d\'ouverture de fichier à implémenter');
                });

                document.getElementById('btn-save').addEventListener('click', () => {
                    const content = editor.getData();
                    const saveStatus = document.getElementById('save-status');
                    
                    fetch('/save_bilan_document', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ content: content })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            saveStatus.innerHTML = `<span class="text-success">✓ ${data.message}</span>`;
                        } else {
                            saveStatus.innerHTML = `<span class="text-danger">✗ ${data.message}</span>`;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        saveStatus.innerHTML = `<span class="text-danger">✗ Erreur de sauvegarde</span>`;
                    });
                });

                // Export to PDF functionality
                document.getElementById('export-pdf').addEventListener('click', function() {
                    const content = editor.getData();
                    const saveStatus = document.getElementById('save-status');
                    
                    fetch('/export_bilan_pdf', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ content: content })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            saveStatus.innerHTML = `<span class="text-success">✓ ${data.message}</span>`;
                        } else {
                            saveStatus.innerHTML = `<span class="text-danger">✗ ${data.message}</span>`;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        saveStatus.innerHTML = `<span class="text-danger">✗ Erreur d'exportation</span>`;
                    });
                });
            })
            .catch(error => {
                console.error('Error initializing CKEditor:', error);
            });
    });
</script>
{% endblock %}
